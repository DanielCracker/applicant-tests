--синтаксис Firebird SQL

-- 1) Количество покупателей из Италии и Франции
SELECT  COUNTRIES.COUNTRY_NAME, 
		COUNT(DISTINCT CUSTOMER_ID) AS CustomerCountDistinct 
FROM ORDERS
LEFT JOIN СUSTOMER ON ORDERS.CUSTOMER_ID = ORDERS.CUSTOMER_ID
LEFT JOIN COUNTRIES ON CUSTOMER.COUNTRY_CODE = COUNTRIES.COUNTRY_CODE
WHERE COUNTRIES.COUNTRY_NAME IN ('FRANCE','ITALY') 
GROUP BY COUNTRIES.COUNTRY_NAME


--2) ТОП 10 покупателей по расходам
SELECT FIRST 10 СUSTOMER.CUSTOMER_NAME, 
				SUM(ITEMS.QUANTITY * ITEMS.ITEM_PRICE) AS REVENUE 
FROM ORDERS
LEFT JOIN СUSTOMER ON ORDERS.CUSTOMER_ID = ORDERS.CUSTOMER_ID
LEFT JOIN ITEMS ON ORDERS.ITEM_ID = ITEMS.ITEM_ID
GROUP BY СUSTOMER.CUSTOMER_NAME
ORDER BY 2 DESC

-- описать второй с оконками, мб эффективнее будет


--3) Общая выручка USD по странам, если нет дохода, вернуть NULL
SELECT  COUNTRIES.COUNTRY_NAME,
		SUM(ITEMS.QUANTITY * ITEMS.ITEM_PRICE) AS REVENUEPERCOUNTRY 
FROM COUNTRIES
LEFT JOIN CUSTOMER ON COUNTRIES.COUNTRY_CODE = СUSTOMER.COUNTRY_CODE
LEFT JOIN ORDERS ON CUSTOMER.CUSTOMER_ID = ORDERS.CUSTOMER_ID
LEFT JOIN ITEMS ON ORDERS.ITEM_ID = ITEMS.ITEM_ID
GROUP BY COUNTRIES.COUNTRY_NAME

--4) Самый дорогой товар, купленный одним покупателем
SELECT  CUSTOMER.CUSTOMER_ID,
		CUSTOMER.CUSTOMER_NAME,
		ITEMS.ITEM_PRICE
		FROM(
	SELECT  CUSTOMER.CUSTOMER_ID,
			CUSTOMER.CUSTOMER_NAME,
			ITEMS.ITEM_PRICE,
			ROW_NUMBER() OVER (PARTITION BY CUSTOMER.CUSTOMER_ID ORDER BY ITEMS.ITEM_PRICE DESC) as RANKED   
	FROM Orders
	LEFT JOIN СUSTOMER ON ORDERS.CUSTOMER_ID = ORDERS.CUSTOMER_ID
	LEFT JOIN ITEMS ON ORDERS.ITEM_ID = ITEMS.ITEM_ID
	)X
WHERE X.RANKED = 1


--5) Ежемесячный доход

SELECT  RIGHT(100 + EXTRACT(MONTH FROM ORDERS.DATE_TIME),2) AS MONTH_NUM, 
		SUM(ITEMS.QUANTITY * ITEMS.ITEM_PRICE) AS TOTAL_REVENUE 
FROM ORDERS
LEFT JOIN ITEMS ON ORDERS.ITEM_ID = ITEMS.ITEM_ID
GROUP BY 1

--6) Найти дубликаты

SELECT * FROM (
	SELECT ORDERS.date_time,
		   ORDERS.customer_id,
		   ORDERS.item_id, 
		   --ROW_NUMBER() OVER (PARTITION BY ORDERS.date_time,ORDERS.customer_id,ORDERS.item_id) AS RANKED,
		   COUNT(*) OVER (PARTITION BY ORDERS.date_time,ORDERS.customer_id,ORDERS.item_id) AS COUNTI	   
	FROM ORDERS 
) X
WHERE X.COUNTI > 1
ORDER BY 1,2,3 --,4

--7) Найти "важных" покупателей
--Возможно не совсем правильно понял формулировку задачи...По сути вывел топов по кол-ву заказов.

SELECT CUSTOMER.Customer_id, COUNT(*) as Total_Orders_Count  FROM ORDERS 
LEFT JOIN СUSTOMER ON ORDERS.CUSTOMER_ID = ORDERS.CUSTOMER_ID
GROUP BY CUSTOMER.Customer_id
ORDER BY 2 DESC

--8) Найти покупателей с "ростом" за последний месяц